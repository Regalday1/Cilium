# cilium-manifest.yaml
apiVersion: talos.dev/v1alpha1
kind: Config
metadata:
  name: cilium-config
spec:
  # Talos cluster settings
  network:
    # Define your networking options here (e.g., IP addressing, CNI)
    cni:
      name: cilium
      conf: "/etc/cilium/cilium-cni.conf"
      
  # Control Plane configuration (for Cilium's Helm chart installation)
  services:
    # Cilium agent service settings
    - name: cilium-agent
      enabled: true
      namespace: kube-system
      containers:
        - name: cilium-agent
          image: quay.io/cilium/cilium:v1.16.6  # Updated version based on input
          args:
            - "--config-dir=/etc/cilium"
            - "--k8s-kubeconfig=/etc/cilium/kubeconfig"
            - "--set ipam.mode=kubernetes"  # Set IPAM mode to Kubernetes
            - "--set kubeProxyReplacement=true"  # Enable kubeProxyReplacement
            - "--set securityContext.capabilities.ciliumAgent={CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}"  # Set capabilities for cilium agent
            - "--set securityContext.capabilities.cleanCiliumState={NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}"  # Set cleanCiliumState capabilities
            - "--set cgroup.autoMount.enabled=false"  # Disable auto mount for cgroup
            - "--set cgroup.hostRoot=/sys/fs/cgroup"  # Set the cgroup host root
            - "--set k8sServiceHost=localhost"  # Set the Kubernetes service host
            - "--set k8sServicePort=7445"  # Set the Kubernetes service port
            - "--set ipv6.enabled=false"  # Disable IPv6
            - "--set securityContext.privileged=true"  # Enable privileged security context
            - "--set hubble.enabled=true"  # Enable Hubble
            - "--set hubble.relay.enabled=true"  # Enable Hubble relay
            - "--set hubble.ui.enabled=true"  # Enable Hubble UI
            - "--set hubble.ui.port=8088"  # Set Hubble UI port
          volumeMounts:
            - mountPath: "/etc/cilium"
              name: cilium-config-volume
            - mountPath: "/var/run/cilium"
              name: cilium-run
    - name: cilium-operator
      enabled: true
      namespace: kube-system
      containers:
        - name: cilium-operator
          image: quay.io/cilium/operator:v1.16.6  # Updated version based on input
          args:
            - "--config-dir=/etc/cilium"
            - "--k8s-kubeconfig=/etc/cilium/kubeconfig"
            - "--set ipam.mode=kubernetes"  # Set IPAM mode to Kubernetes
            - "--set kubeProxyReplacement=true"  # Enable kubeProxyReplacement
            - "--set securityContext.capabilities.ciliumAgent={CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}"  # Set capabilities for cilium agent
            - "--set securityContext.capabilities.cleanCiliumState={NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}"  # Set cleanCiliumState capabilities
            - "--set cgroup.autoMount.enabled=false"  # Disable auto mount for cgroup
            - "--set cgroup.hostRoot=/sys/fs/cgroup"  # Set the cgroup host root
            - "--set k8sServiceHost=localhost"  # Set the Kubernetes service host
            - "--set k8sServicePort=7445"  # Set the Kubernetes service port
            - "--set ipv6.enabled=false"  # Disable IPv6
            - "--set securityContext.privileged=true"  # Enable privileged security context
            - "--set hubble.enabled=true"  # Enable Hubble
            - "--set hubble.relay.enabled=true"  # Enable Hubble relay
            - "--set hubble.ui.enabled=true"  # Enable Hubble UI
            - "--set hubble.ui.port=8088"  # Set Hubble UI port
          volumeMounts:
            - mountPath: "/etc/cilium"
              name: cilium-config-volume
    - name: cilium-envoy
      enabled: true
      namespace: kube-system
      containers:
        - name: cilium-envoy
          image: quay.io/cilium/envoy:v1.16.6  # Updated version based on input
          args:
            - "--set ipam.mode=kubernetes"  # Set IPAM mode to Kubernetes
            - "--set kubeProxyReplacement=true"  # Enable kubeProxyReplacement
            - "--set securityContext.capabilities.ciliumAgent={CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}"  # Set capabilities for cilium agent
            - "--set securityContext.capabilities.cleanCiliumState={NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}"  # Set cleanCiliumState capabilities
            - "--set cgroup.autoMount.enabled=false"  # Disable auto mount for cgroup
            - "--set cgroup.hostRoot=/sys/fs/cgroup"  # Set the cgroup host root
            - "--set k8sServiceHost=localhost"  # Set the Kubernetes service host
            - "--set k8sServicePort=7445"  # Set the Kubernetes service port
            - "--set ipv6.enabled=false"  # Disable IPv6
            - "--set securityContext.privileged=true"  # Enable privileged security context
            - "--set hubble.enabled=true"  # Enable Hubble
            - "--set hubble.relay.enabled=true"  # Enable Hubble relay
            - "--set hubble.ui.enabled=true"  # Enable Hubble UI
            - "--set hubble.ui.port=8088"  # Set Hubble UI port
          volumeMounts:
            - mountPath: "/etc/cilium"
              name: cilium-config-volume
            - mountPath: "/var/run/cilium"
              name: cilium-run

  # Networking options
  networking:
    # Configure network interfaces and IP settings
    interfaces:
      - name: eth0
        dhcp: true
        mtu: 1500

  # Volumes for configuration
  volumes:
    - name: cilium-config-volume
      hostPath:
        path: /etc/cilium
    - name: cilium-run
      hostPath:
        path: /var/run/cilium

  # Enable specific features like monitoring, etc.
  featureGates:
    - name: Hubble
      enabled: true

  # Other relevant settings for Talos
  talos:
    services:
      # Additional configurations as required
